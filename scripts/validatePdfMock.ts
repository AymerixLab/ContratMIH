import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Import des constantes et donn√©es
import {
  standPrices,
  anglePrice,
  electricityPrices,
  exteriorSpacePrice,
  gardenCottagePrice,
  amenagementPrices,
  visibilitePrices,
  readyToExposePrices
} from '../src/lib/constants.js';

import {
  mockFormData,
  mockReservationData,
  mockAmenagementData,
  mockVisibiliteData
} from '../src/lib/mockData.js';

interface ValidationError {
  section: string;
  item: string;
  expected: number;
  actual: number;
  difference: number;
  formula: string;
}

const errors: ValidationError[] = [];
const warnings: string[] = [];

// Fonction helper pour arrondir √† 2 d√©cimales
const round = (n: number) => Math.round(n * 100) / 100;

console.log('üîç VALIDATION DES CALCULS DU PDF MOCK\n');
console.log('=' .repeat(80));

// ==========================================
// SECTION 1: R√âSERVATION D'ESPACE (HT 01)
// ==========================================
console.log('\nüìã SECTION 1: R√âSERVATION D\'ESPACE\n');

let ht01 = 0;

// Stand √©quip√©
if (mockReservationData.standType === 'equipped') {
  const size = parseInt(mockReservationData.standSize);
  const unitPrice = standPrices.equipped;
  const expected = round(size * unitPrice);
  const pdfValue = 4860.00; // Valeur extraite du PDF

  ht01 += expected;

  console.log(`Stand √©quip√© ${size}m¬≤`);
  console.log(`  Formule: ${size} √ó ${unitPrice}‚Ç¨/m¬≤ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'R√©servation - Stand √©quip√©',
      item: `Stand √©quip√© ${size}m¬≤`,
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `${size} √ó ${unitPrice}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// Angles ouverts
if (mockReservationData.standAngles > 0) {
  const qty = mockReservationData.standAngles;
  const expected = round(qty * anglePrice);
  const pdfValue = 370.00; // Valeur extraite du PDF

  ht01 += expected;

  console.log(`\nAngles ouverts`);
  console.log(`  Formule: ${qty} √ó ${anglePrice}‚Ç¨ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'R√©servation - Angles',
      item: `${qty} angle(s)`,
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `${qty} √ó ${anglePrice}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// √âlectricit√© sup√©rieure
if (mockReservationData.electricityUpgrade && mockReservationData.electricityUpgrade !== 'none') {
  const upgrade = mockReservationData.electricityUpgrade as keyof typeof electricityPrices;
  const expected = electricityPrices[upgrade];

  // Dans le PDF, on voit 3 lignes d'√©lectricit√© avec 220, 260, 350
  // Mais d'apr√®s le mock, electricityUpgrade = 'none'
  console.log(`\n‚ö†Ô∏è  √âlectricit√© sup√©rieure: mock = '${mockReservationData.electricityUpgrade}'`);
  console.log(`    Le PDF montre les 3 options avec quantit√© = 1 chacune`);
  console.log(`    Cela semble √™tre un probl√®me de mock ou de mapping`);

  warnings.push('√âlectricit√©: Le mock indique "none" mais le PDF affiche les 3 options');
}

// Espace ext√©rieur
if (mockReservationData.exteriorSpace) {
  const surface = parseInt(mockReservationData.exteriorSurface);
  const expected = round(surface * exteriorSpacePrice);
  const pdfValue = 600.00; // Valeur extraite du PDF

  ht01 += expected;

  console.log(`\nEspace ext√©rieur`);
  console.log(`  Formule: ${surface}m¬≤ √ó ${exteriorSpacePrice}‚Ç¨/m¬≤ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'R√©servation - Espace ext√©rieur',
      item: `${surface}m¬≤ ext√©rieur`,
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `${surface} √ó ${exteriorSpacePrice}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// Garden cottage
if (mockReservationData.gardenCottage) {
  const expected = gardenCottagePrice;
  const pdfValue = 800.00; // Valeur extraite du PDF

  ht01 += expected;

  console.log(`\nGarden cottage`);
  console.log(`  Formule: 1 √ó ${expected}‚Ç¨ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'R√©servation - Garden cottage',
      item: 'Garden cottage',
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `1 √ó ${expected}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// NOTE: Dans le PDF, on voit les 3 lignes d'√©lectricit√© avec quantit√© = 1
// Mais normalement on n'en s√©lectionne qu'une seule
// D'apr√®s le PDF: 220 + 260 + 350 = 830‚Ç¨
// Mais le mock dit electricityUpgrade = 'none'
// Donc pour matcher le PDF, il faut ajouter les 3 lignes:
const elecPdfTotal = 220 + 260 + 350;
console.log(`\n‚ö†Ô∏è  √âlectricit√©: Le PDF affiche les 3 coffrets avec 830‚Ç¨ au total`);
console.log(`    Mock dit: '${mockReservationData.electricityUpgrade}'`);
console.log(`    Cela semble incorrect - normalement on s√©lectionne UNE SEULE puissance`);
warnings.push(`√âlectricit√©: Le PDF affiche 3 coffrets (830‚Ç¨) mais le mock dit "${mockReservationData.electricityUpgrade}"`);

// NE PAS ajouter l'√©lectricit√© pour le moment car c'est incorrect
// ht01 += elecPdfTotal;

const pdfHT01 = 8230.00;
console.log(`\n${'‚îÄ'.repeat(60)}`);
console.log(`TOTAL HT 01 calcul√©: ${ht01.toFixed(2)}‚Ç¨`);
console.log(`TOTAL HT 01 PDF: ${pdfHT01}‚Ç¨`);

if (round(ht01) !== pdfHT01) {
  console.log(`‚ùå ERREUR TOTAL HT 01: √âcart de ${round(pdfHT01 - ht01)}‚Ç¨`);
  errors.push({
    section: 'TOTAL HT 01',
    item: 'R√©servation d\'espace',
    expected: round(ht01),
    actual: pdfHT01,
    difference: pdfHT01 - round(ht01),
    formula: 'Somme des lignes section 1'
  });
} else {
  console.log(`‚úÖ TOTAL HT 01 OK`);
}

// ==========================================
// SECTION 2: AM√âNAGEMENTS (HT 02)
// ==========================================
console.log('\n\nüìã SECTION 2: AM√âNAGEMENTS OPTIONNELS\n');

let ht02 = 0;

// √âquipements stands
const equipements = [
  { name: 'R√©serve m√©lamin√©e', qty: mockAmenagementData.reservePorteMelamine, price: amenagementPrices.reservePorteMelamine, pdfValue: 200.00 },
  { name: 'Moquette diff√©rente', qty: mockAmenagementData.moquetteDifferente, price: amenagementPrices.moquetteDifferente, pdfValue: 117.00 },
  { name: 'Velum stand', qty: mockAmenagementData.velumStand, price: amenagementPrices.velumStand, pdfValue: 270.00 },
  { name: 'Cloison bois gain√©e', qty: mockAmenagementData.cloisonBoisGainee, price: amenagementPrices.cloisonBoisGainee, pdfValue: 300.00 },
  { name: 'Bandeau signal√©tique', qty: mockAmenagementData.bandeauSignaletique, price: amenagementPrices.bandeauSignaletique, pdfValue: 210.00 },
];

console.log('√âquipements stands:');
equipements.forEach(item => {
  if (item.qty > 0) {
    const expected = round(item.qty * item.price);
    ht02 += expected;

    console.log(`\n  ${item.name}`);
    console.log(`    Formule: ${item.qty} √ó ${item.price}‚Ç¨ = ${expected}‚Ç¨`);
    console.log(`    PDF: ${item.pdfValue}‚Ç¨`);

    if (expected !== item.pdfValue) {
      errors.push({
        section: 'Am√©nagements - √âquipements',
        item: item.name,
        expected,
        actual: item.pdfValue,
        difference: item.pdfValue - expected,
        formula: `${item.qty} √ó ${item.price}`
      });
      console.log(`    ‚ùå ERREUR: √âcart de ${item.pdfValue - expected}‚Ç¨`);
    } else {
      console.log(`    ‚úÖ OK`);
    }
  }
});

// Mobilier
const mobilier = [
  { name: 'Comptoir', qty: mockAmenagementData.comptoir, price: amenagementPrices.comptoir, pdfValue: 165.00 },
  { name: 'Tabouret', qty: mockAmenagementData.tabouret, price: amenagementPrices.tabouret, pdfValue: 80.00 },
  { name: 'Mange-debout', qty: mockAmenagementData.mangeDebout, price: amenagementPrices.mangeDebout, pdfValue: 90.00 },
  { name: 'Chaise', qty: mockAmenagementData.chaise, price: amenagementPrices.chaise, pdfValue: 80.00 },
  { name: 'Table 120x60', qty: mockAmenagementData.table120x60, price: amenagementPrices.table120x60, pdfValue: 80.00 },
  { name: 'Mange + 3 tabourets', qty: mockAmenagementData.mange3Tabourets, price: amenagementPrices.mange3Tabourets, pdfValue: 195.00 },
  { name: '√âcran 52"', qty: mockAmenagementData.ecran52, price: amenagementPrices.ecran52, pdfValue: 395.00 },
  { name: 'R√©frig√©rateur 140L', qty: mockAmenagementData.refrigerateur140, price: amenagementPrices.refrigerateur140, pdfValue: 125.00 },
  { name: 'R√©frig√©rateur 240L', qty: mockAmenagementData.refrigerateur240, price: amenagementPrices.refrigerateur240, pdfValue: 210.00 },
  { name: 'Pr√©sentoir A4', qty: mockAmenagementData.presentoirA4, price: amenagementPrices.presentoirA4, pdfValue: 115.00 },
  { name: 'Bloc prises', qty: mockAmenagementData.blocPrises, price: amenagementPrices.blocPrises, pdfValue: 36.00 },
  { name: 'Fauteuil', qty: mockAmenagementData.fauteuil, price: amenagementPrices.fauteuil, pdfValue: 118.00 },
  { name: 'Table basse', qty: mockAmenagementData.tableBasse, price: amenagementPrices.tableBasse, pdfValue: 55.00 },
  { name: 'Gu√©ridon haut', qty: mockAmenagementData.gueridonHaut, price: amenagementPrices.gueridonHaut, pdfValue: 55.00 },
  { name: 'Pouf cube', qty: mockAmenagementData.poufCube, price: amenagementPrices.poufCube, pdfValue: 33.00 },
  { name: 'Colonne vitrine', qty: mockAmenagementData.colonneVitrine, price: amenagementPrices.colonneVitrine, pdfValue: 252.00 },
  { name: 'Comptoir vitrine', qty: mockAmenagementData.comptoirVitrine, price: amenagementPrices.comptoirVitrine, pdfValue: 271.00 },
  { name: 'Porte-manteaux', qty: mockAmenagementData.porteManteux, price: amenagementPrices.porteManteux, pdfValue: 51.00 },
  { name: 'Plante bambou', qty: mockAmenagementData.planteBambou, price: amenagementPrices.planteBambou, pdfValue: 50.00 },
];

console.log('\n\nMobilier:');
mobilier.forEach(item => {
  if (item.qty > 0) {
    const expected = round(item.qty * item.price);
    ht02 += expected;

    console.log(`\n  ${item.name}`);
    console.log(`    Formule: ${item.qty} √ó ${item.price}‚Ç¨ = ${expected}‚Ç¨`);
    console.log(`    PDF: ${item.pdfValue}‚Ç¨`);

    if (expected !== item.pdfValue) {
      errors.push({
        section: 'Am√©nagements - Mobilier',
        item: item.name,
        expected,
        actual: item.pdfValue,
        difference: item.pdfValue - expected,
        formula: `${item.qty} √ó ${item.price}`
      });
      console.log(`    ‚ùå ERREUR: √âcart de ${item.pdfValue - expected}‚Ç¨`);
    } else {
      console.log(`    ‚úÖ OK`);
    }
  }
});

const pdfHT02 = 3853.00;
console.log(`\n${'‚îÄ'.repeat(60)}`);
console.log(`TOTAL HT 02 calcul√©: ${ht02.toFixed(2)}‚Ç¨`);
console.log(`TOTAL HT 02 PDF: ${pdfHT02}‚Ç¨`);

if (round(ht02) !== pdfHT02) {
  console.log(`‚ùå ERREUR TOTAL HT 02: √âcart de ${round(pdfHT02 - ht02)}‚Ç¨`);
  errors.push({
    section: 'TOTAL HT 02',
    item: 'Am√©nagements optionnels',
    expected: round(ht02),
    actual: pdfHT02,
    difference: pdfHT02 - round(ht02),
    formula: 'Somme des lignes section 2'
  });
} else {
  console.log(`‚úÖ TOTAL HT 02 OK`);
}

// ==========================================
// SECTION 3: PRODUITS COMPL√âMENTAIRES + VISIBILIT√â (HT 03)
// ==========================================
console.log('\n\nüìã SECTION 3: PRODUITS COMPL√âMENTAIRES & VISIBILIT√â\n');

let ht03 = 0;

// Scan badges
if (mockAmenagementData.scanBadges) {
  const expected = amenagementPrices.scanBadges;
  const pdfValue = 150.00;

  ht03 += expected;

  console.log('Scan badges visiteurs');
  console.log(`  Formule: 1 √ó ${expected}‚Ç¨ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'Produits compl√©mentaires',
      item: 'Scan badges',
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `1 √ó ${expected}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// Pass soir√©e
if (mockAmenagementData.passSoiree > 0) {
  const qty = mockAmenagementData.passSoiree;
  const expected = round(qty * amenagementPrices.passSoiree);
  const pdfValue = 150.00;

  ht03 += expected;

  console.log(`\nPass soir√©e suppl√©mentaires`);
  console.log(`  Formule: ${qty} √ó ${amenagementPrices.passSoiree}‚Ç¨ = ${expected}‚Ç¨`);
  console.log(`  PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'Produits compl√©mentaires',
      item: 'Pass soir√©e',
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: `${qty} √ó ${amenagementPrices.passSoiree}`
    });
    console.log(`  ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`  ‚úÖ OK`);
  }
}

// Visibilit√©
const visibilite = [
  { name: 'Pack signal√©tique complet', active: mockVisibiliteData.packSignaletiqueComplet, price: visibilitePrices.packSignaletiqueComplet, pdfValue: 1020.00 },
  { name: 'Signal√©tique comptoir', active: mockVisibiliteData.signaletiqueComptoir, price: visibilitePrices.signaletiqueComptoir, pdfValue: 180.00 },
  { name: 'Signal√©tique haut cloisons', active: mockVisibiliteData.signaletiqueHautCloisons, price: visibilitePrices.signaletiqueHautCloisons, pdfValue: 435.00 },
  { name: 'Signal√©tique enseigne haute', active: mockVisibiliteData.signaletiqueEnseigneHaute, price: visibilitePrices.signaletiqueEnseigneHaute, pdfValue: 225.00 },
  { name: '1/2 page catalogue', active: mockVisibiliteData.demiPageCatalogue, price: visibilitePrices.demiPageCatalogue, pdfValue: 700.00 },
  { name: 'Page compl√®te catalogue', active: mockVisibiliteData.pageCompleeteCatalogue, price: visibilitePrices.pageCompleeteCatalogue, pdfValue: 1200.00 },
  { name: 'Deuxi√®me couverture', active: mockVisibiliteData.deuxiemeCouverture, price: visibilitePrices.deuxiemeCouverture, pdfValue: 1800.00 },
  { name: 'Quatri√®me couverture', active: mockVisibiliteData.quatriemeCouverture, price: visibilitePrices.quatriemeCouverture, pdfValue: 2300.00 },
  { name: 'Logo plan salon', active: mockVisibiliteData.logoplanSalon, price: visibilitePrices.logoplanSalon, pdfValue: 550.00 },
  { name: 'Documentation sac visiteur', active: mockVisibiliteData.documentationSacVisiteur, price: visibilitePrices.documentationSacVisiteur, pdfValue: 900.00 },
  { name: 'Distribution h√¥tesse', active: mockVisibiliteData.distributionHotesse, price: visibilitePrices.distributionHotesse, pdfValue: 1500.00 },
];

console.log('\n\nVisibilit√© & Communication:');
visibilite.forEach(item => {
  if (item.active) {
    const expected = item.price;
    ht03 += expected;

    console.log(`\n  ${item.name}`);
    console.log(`    Formule: 1 √ó ${item.price}‚Ç¨ = ${expected}‚Ç¨`);
    console.log(`    PDF: ${item.pdfValue}‚Ç¨`);

    if (expected !== item.pdfValue) {
      errors.push({
        section: 'Visibilit√©',
        item: item.name,
        expected,
        actual: item.pdfValue,
        difference: item.pdfValue - expected,
        formula: `1 √ó ${item.price}`
      });
      console.log(`    ‚ùå ERREUR: √âcart de ${item.pdfValue - expected}‚Ç¨`);
    } else {
      console.log(`    ‚úÖ OK`);
    }
  }
});

// Signal√©tique cloison compl√®te (cas sp√©cial)
if (mockVisibiliteData.signalethqueCloisons > 0) {
  const qty = mockVisibiliteData.signalethqueCloisons;
  let expected: number;

  if (qty >= 3) {
    // Premier √† 185‚Ç¨, les suivants √† 120‚Ç¨
    expected = round(visibilitePrices.signalethqueCloisons + (qty - 1) * 120);
  } else {
    expected = round(qty * visibilitePrices.signalethqueCloisons);
  }

  const pdfValue = 370.00; // 2 cloisons dans le PDF
  ht03 += expected;

  console.log(`\n  Signal√©tique cloison compl√®te`);
  console.log(`    Quantit√©: ${qty}`);
  console.log(`    Formule: ${qty >= 3 ? `185‚Ç¨ + ${qty - 1} √ó 120‚Ç¨` : `${qty} √ó 185‚Ç¨`} = ${expected}‚Ç¨`);
  console.log(`    PDF: ${pdfValue}‚Ç¨`);

  if (expected !== pdfValue) {
    errors.push({
      section: 'Visibilit√©',
      item: 'Signal√©tique cloison compl√®te',
      expected,
      actual: pdfValue,
      difference: pdfValue - expected,
      formula: qty >= 3 ? `185 + ${qty - 1} √ó 120` : `${qty} √ó 185`
    });
    console.log(`    ‚ùå ERREUR: √âcart de ${pdfValue - expected}‚Ç¨`);
  } else {
    console.log(`    ‚úÖ OK`);
  }
}

const pdfHT03 = 11180.00;
console.log(`\n${'‚îÄ'.repeat(60)}`);
console.log(`TOTAL HT 03 calcul√©: ${ht03.toFixed(2)}‚Ç¨`);
console.log(`TOTAL HT 03 PDF: ${pdfHT03}‚Ç¨`);

if (round(ht03) !== pdfHT03) {
  console.log(`‚ùå ERREUR TOTAL HT 03: √âcart de ${round(pdfHT03 - ht03)}‚Ç¨`);
  errors.push({
    section: 'TOTAL HT 03',
    item: 'Produits compl√©mentaires + Visibilit√©',
    expected: round(ht03),
    actual: pdfHT03,
    difference: pdfHT03 - round(ht03),
    formula: 'Somme des lignes section 3'
  });
} else {
  console.log(`‚úÖ TOTAL HT 03 OK`);
}

// ==========================================
// TOTAUX FINAUX
// ==========================================
console.log('\n\nüìã TOTAUX FINAUX\n');

const totalHTCalculated = round(ht01 + ht02 + ht03);
const totalHTPdf = 23263.00;

console.log(`Total HT calcul√©: ${totalHTCalculated.toFixed(2)}‚Ç¨`);
console.log(`Total HT PDF: ${totalHTPdf}‚Ç¨`);

if (totalHTCalculated !== totalHTPdf) {
  console.log(`‚ùå ERREUR TOTAL HT: √âcart de ${round(totalHTPdf - totalHTCalculated)}‚Ç¨`);
  errors.push({
    section: 'TOTAUX FINAUX',
    item: 'Total HT',
    expected: totalHTCalculated,
    actual: totalHTPdf,
    difference: totalHTPdf - totalHTCalculated,
    formula: 'HT01 + HT02 + HT03'
  });
} else {
  console.log(`‚úÖ TOTAL HT OK`);
}

const tvaCalculated = round(totalHTCalculated * 0.20);
const tvaPdf = 4652.60;

console.log(`\nTVA 20% calcul√©e: ${tvaCalculated.toFixed(2)}‚Ç¨`);
console.log(`TVA 20% PDF: ${tvaPdf}‚Ç¨`);

if (Math.abs(tvaCalculated - tvaPdf) > 0.01) {
  console.log(`‚ùå ERREUR TVA: √âcart de ${round(tvaPdf - tvaCalculated)}‚Ç¨`);
  errors.push({
    section: 'TOTAUX FINAUX',
    item: 'TVA 20%',
    expected: tvaCalculated,
    actual: tvaPdf,
    difference: tvaPdf - tvaCalculated,
    formula: 'Total HT √ó 20%'
  });
} else {
  console.log(`‚úÖ TVA OK`);
}

const totalTTCCalculated = round(totalHTCalculated + tvaCalculated);
const totalTTCPdf = 27915.60;

console.log(`\nTotal TTC calcul√©: ${totalTTCCalculated.toFixed(2)}‚Ç¨`);
console.log(`Total TTC PDF: ${totalTTCPdf}‚Ç¨`);

if (Math.abs(totalTTCCalculated - totalTTCPdf) > 0.01) {
  console.log(`‚ùå ERREUR TOTAL TTC: √âcart de ${round(totalTTCPdf - totalTTCCalculated)}‚Ç¨`);
  errors.push({
    section: 'TOTAUX FINAUX',
    item: 'Total TTC',
    expected: totalTTCCalculated,
    actual: totalTTCPdf,
    difference: totalTTCPdf - totalTTCCalculated,
    formula: 'Total HT + TVA'
  });
} else {
  console.log(`‚úÖ TOTAL TTC OK`);
}

// ==========================================
// RAPPORT FINAL
// ==========================================
console.log('\n\n' + '='.repeat(80));
console.log('üìä RAPPORT DE VALIDATION');
console.log('='.repeat(80));

if (errors.length === 0 && warnings.length === 0) {
  console.log('\n‚úÖ Aucune erreur d√©tect√©e ! Tous les calculs sont corrects.');
} else {
  if (errors.length > 0) {
    console.log(`\n‚ùå ${errors.length} erreur(s) d√©tect√©e(s):\n`);

    errors.forEach((error, index) => {
      console.log(`${index + 1}. [${error.section}] ${error.item}`);
      console.log(`   Formule: ${error.formula}`);
      console.log(`   Attendu: ${error.expected.toFixed(2)}‚Ç¨`);
      console.log(`   Actuel (PDF): ${error.actual.toFixed(2)}‚Ç¨`);
      console.log(`   √âcart: ${error.difference > 0 ? '+' : ''}${error.difference.toFixed(2)}‚Ç¨`);
      console.log('');
    });
  }

  if (warnings.length > 0) {
    console.log(`\n‚ö†Ô∏è  ${warnings.length} avertissement(s):\n`);
    warnings.forEach((warning, index) => {
      console.log(`${index + 1}. ${warning}`);
    });
  }
}

// G√©n√©rer un fichier de rapport
const reportContent = `# Rapport de validation du PDF Mock

Date: ${new Date().toLocaleString('fr-FR')}

## R√©sum√©

- Erreurs d√©tect√©es: ${errors.length}
- Avertissements: ${warnings.length}

## D√©tails des erreurs

${errors.length === 0 ? '‚úÖ Aucune erreur' : errors.map((error, index) => `
### ${index + 1}. ${error.section} - ${error.item}

- **Formule**: \`${error.formula}\`
- **Attendu**: ${error.expected.toFixed(2)}‚Ç¨
- **Actuel (PDF)**: ${error.actual.toFixed(2)}‚Ç¨
- **√âcart**: ${error.difference > 0 ? '+' : ''}${error.difference.toFixed(2)}‚Ç¨
`).join('\n')}

## Avertissements

${warnings.length === 0 ? '‚úÖ Aucun avertissement' : warnings.map((w, i) => `${i + 1}. ${w}`).join('\n')}

## Totaux r√©capitulatifs

| Section | Calcul√© | PDF | √âcart |
|---------|---------|-----|-------|
| HT 01 | ${ht01.toFixed(2)}‚Ç¨ | ${pdfHT01}‚Ç¨ | ${(pdfHT01 - ht01).toFixed(2)}‚Ç¨ |
| HT 02 | ${ht02.toFixed(2)}‚Ç¨ | ${pdfHT02}‚Ç¨ | ${(pdfHT02 - ht02).toFixed(2)}‚Ç¨ |
| HT 03 | ${ht03.toFixed(2)}‚Ç¨ | ${pdfHT03}‚Ç¨ | ${(pdfHT03 - ht03).toFixed(2)}‚Ç¨ |
| **Total HT** | **${totalHTCalculated.toFixed(2)}‚Ç¨** | **${totalHTPdf}‚Ç¨** | **${(totalHTPdf - totalHTCalculated).toFixed(2)}‚Ç¨** |
| TVA 20% | ${tvaCalculated.toFixed(2)}‚Ç¨ | ${tvaPdf}‚Ç¨ | ${(tvaPdf - tvaCalculated).toFixed(2)}‚Ç¨ |
| **Total TTC** | **${totalTTCCalculated.toFixed(2)}‚Ç¨** | **${totalTTCPdf}‚Ç¨** | **${(totalTTCPdf - totalTTCCalculated).toFixed(2)}‚Ç¨** |
`;

const reportPath = path.join(__dirname, '..', 'pdf-validation-report.md');
fs.writeFileSync(reportPath, reportContent, 'utf-8');

console.log(`\nüìÑ Rapport d√©taill√© g√©n√©r√©: pdf-validation-report.md`);
console.log('\n' + '='.repeat(80));

// Exit code
process.exit(errors.length > 0 ? 1 : 0);
